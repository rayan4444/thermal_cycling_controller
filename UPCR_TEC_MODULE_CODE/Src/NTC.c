#include "NTC.h"
/*
This code assumes the following PCB configuration: 
- One TEC only for cooling 
- One resistive heater only 
*/
uint16_t temp_to_adc(uint16_t temp)
{
    uint16_t i = 0;
    while ((i < TABLE_SIZE) && (temp > temp_table[i].y)) {
        i++;
    }
    if (i == TABLE_SIZE) {
        return temp_table[i - 1].x;
    }
    // linear interpolation (approximate because we are only using integer division)
    int16_t c = (temp_table[i].x - temp_table[i - 1].x) / (temp_table[i].y - temp_table[i - 1].y);
    return c * (temp - temp_table[i].y) + temp_table[i].x;
}

int32_t compute_temp_PID(uint16_t Setpoint, uint16_t Input)
{
    //set working variables
    int32_t Output;
    // Setpoint = result from temp_to_ADC
    // Input = what the ADC is actually reading

    // because our deltaT is a constant, we fold it into our KI, KP and KD

    //Compute error
    error = Setpoint - Input;
    //Compute Integral of error
    Iterm += error * KI; // scale first then integrate, https://www.embeddedrelated.com/showarticle/121.php

    //Compute Derivative of error
    //dErr = (error - lastErr) / timeChange;
    dErr = (Input - lastInput); // Use delta input instead of delta error so it doesn't go crazy when you give it a step change in setpoint.

    // manage integrator windup error ; see http://brettbeauregard.com/blog/2011/04/improving-the-beginner%e2%80%99s-pid-reset-windup/
    if (Iterm > 100) {
        Iterm = 100;
    } else if (Iterm < -100) {
        Iterm = -100;
    }

    //Compute PID Output
    Output = KP * error + Iterm - KD * dErr;

    //set boundaries
    // PWM given in % Duty Cycle
    if (Output < -100) {
        Output = -100;
    }
    if (Output > 100) {
        Output = 100;
    }
    /*decide whether to drive cooler or heater*/

    /*Remember some variables for next time*/
    lastErr = error;
    lastInput = Input;

    return Output;
}
const temp_lookup_t temp_table[TABLE_SIZE] __attribute__((section(".rodata.temp_table"))) = {
    //.x is the ADC value and .y corresponds to the hundredths of deg C
    { .x = 11, .y = 35054 },
    { .x = 21, .y = 28383 },
    { .x = 31, .y = 25004 },
    { .x = 41, .y = 22815 },
    { .x = 51, .y = 21226 },
    { .x = 61, .y = 19993 },
    { .x = 71, .y = 18993 },
    { .x = 81, .y = 18156 },
    { .x = 91, .y = 17441 },
    { .x = 101, .y = 16817 },
    { .x = 111, .y = 16265 },
    { .x = 121, .y = 15772 },
    { .x = 131, .y = 15327 },
    { .x = 141, .y = 14921 },
    { .x = 151, .y = 14550 },
    { .x = 161, .y = 14207 },
    { .x = 171, .y = 13888 },
    { .x = 181, .y = 13593 },
    { .x = 191, .y = 13316 },
    { .x = 201, .y = 13056 },
    { .x = 211, .y = 12811 },
    { .x = 221, .y = 12579 },
    { .x = 231, .y = 12360 },
    { .x = 241, .y = 12151 },
    { .x = 251, .y = 11953 },
    { .x = 261, .y = 11764 },
    { .x = 271, .y = 11583 },
    { .x = 281, .y = 11410 },
    { .x = 291, .y = 11244 },
    { .x = 301, .y = 11084 },
    { .x = 311, .y = 10931 },
    { .x = 321, .y = 10783 },
    { .x = 331, .y = 10640 },
    { .x = 341, .y = 10503 },
    { .x = 351, .y = 10370 },
    { .x = 361, .y = 10241 },
    { .x = 371, .y = 10116 },
    { .x = 381, .y = 9995 },
    { .x = 391, .y = 9878 },
    { .x = 401, .y = 9763 },
    { .x = 411, .y = 9653 },
    { .x = 421, .y = 9545 },
    { .x = 431, .y = 9440 },
    { .x = 441, .y = 9337 },
    { .x = 451, .y = 9238 },
    { .x = 461, .y = 9140 },
    { .x = 471, .y = 9045 },
    { .x = 481, .y = 8953 },
    { .x = 491, .y = 8862 },
    { .x = 501, .y = 8773 },
    { .x = 511, .y = 8687 },
    { .x = 521, .y = 8602 },
    { .x = 531, .y = 8519 },
    { .x = 541, .y = 8437 },
    { .x = 551, .y = 8358 },
    { .x = 561, .y = 8280 },
    { .x = 571, .y = 8203 },
    { .x = 581, .y = 8128 },
    { .x = 591, .y = 8054 },
    { .x = 601, .y = 7981 },
    { .x = 611, .y = 7909 },
    { .x = 621, .y = 7840 },
    { .x = 631, .y = 7770 },
    { .x = 641, .y = 7704 },
    { .x = 651, .y = 7637 },
    { .x = 661, .y = 7572 },
    { .x = 671, .y = 7506 },
    { .x = 681, .y = 7444 },
    { .x = 691, .y = 7381 },
    { .x = 701, .y = 7320 },
    { .x = 711, .y = 7259 },
    { .x = 721, .y = 7198 },
    { .x = 731, .y = 7140 },
    { .x = 741, .y = 7081 },
    { .x = 751, .y = 7025 },
    { .x = 761, .y = 6968 },
    { .x = 771, .y = 6913 },
    { .x = 781, .y = 6858 },
    { .x = 791, .y = 6803 },
    { .x = 801, .y = 6750 },
    { .x = 811, .y = 6697 },
    { .x = 821, .y = 6645 },
    { .x = 831, .y = 6593 },
    { .x = 841, .y = 6542 },
    { .x = 851, .y = 6491 },
    { .x = 861, .y = 6442 },
    { .x = 871, .y = 6392 },
    { .x = 881, .y = 6343 },
    { .x = 891, .y = 6295 },
    { .x = 901, .y = 6248 },
    { .x = 911, .y = 6200 },
    { .x = 921, .y = 6154 },
    { .x = 931, .y = 6108 },
    { .x = 941, .y = 6062 },
    { .x = 951, .y = 6017 },
    { .x = 961, .y = 5972 },
    { .x = 971, .y = 5927 },
    { .x = 981, .y = 5884 },
    { .x = 991, .y = 5840 },
    { .x = 1001, .y = 5797 },
    { .x = 1011, .y = 5754 },
    { .x = 1021, .y = 5712 },
    { .x = 1031, .y = 5670 },
    { .x = 1041, .y = 5629 },
    { .x = 1051, .y = 5587 },
    { .x = 1061, .y = 5547 },
    { .x = 1071, .y = 5506 },
    { .x = 1081, .y = 5466 },
    { .x = 1091, .y = 5426 },
    { .x = 1101, .y = 5387 },
    { .x = 1111, .y = 5348 },
    { .x = 1121, .y = 5309 },
    { .x = 1131, .y = 5270 },
    { .x = 1141, .y = 5232 },
    { .x = 1151, .y = 5194 },
    { .x = 1161, .y = 5156 },
    { .x = 1171, .y = 5119 },
    { .x = 1181, .y = 5082 },
    { .x = 1191, .y = 5045 },
    { .x = 1201, .y = 5009 },
    { .x = 1211, .y = 4972 },
    { .x = 1221, .y = 4936 },
    { .x = 1231, .y = 4901 },
    { .x = 1241, .y = 4865 },
    { .x = 1251, .y = 4830 },
    { .x = 1261, .y = 4795 },
    { .x = 1271, .y = 4760 },
    { .x = 1281, .y = 4725 },
    { .x = 1291, .y = 4691 },
    { .x = 1301, .y = 4657 },
    { .x = 1311, .y = 4623 },
    { .x = 1321, .y = 4589 },
    { .x = 1331, .y = 4555 },
    { .x = 1341, .y = 4522 },
    { .x = 1351, .y = 4489 },
    { .x = 1361, .y = 4456 },
    { .x = 1371, .y = 4423 },
    { .x = 1381, .y = 4391 },
    { .x = 1391, .y = 4358 },
    { .x = 1401, .y = 4326 },
    { .x = 1411, .y = 4294 },
    { .x = 1421, .y = 4262 },
    { .x = 1431, .y = 4230 },
    { .x = 1441, .y = 4199 },
    { .x = 1451, .y = 4167 },
    { .x = 1461, .y = 4136 },
    { .x = 1471, .y = 4105 },
    { .x = 1481, .y = 4074 },
    { .x = 1491, .y = 4043 },
    { .x = 1501, .y = 4013 },
    { .x = 1511, .y = 3982 },
    { .x = 1521, .y = 3952 },
    { .x = 1531, .y = 3922 },
    { .x = 1541, .y = 3892 },
    { .x = 1551, .y = 3861 },
    { .x = 1561, .y = 3832 },
    { .x = 1571, .y = 3803 },
    { .x = 1581, .y = 3772 },
    { .x = 1591, .y = 3744 },
    { .x = 1601, .y = 3714 },
    { .x = 1611, .y = 3685 },
    { .x = 1621, .y = 3656 },
    { .x = 1631, .y = 3627 },
    { .x = 1641, .y = 3597 },
    { .x = 1651, .y = 3570 },
    { .x = 1661, .y = 3540 },
    { .x = 1671, .y = 3513 },
    { .x = 1681, .y = 3484 },
    { .x = 1691, .y = 3456 },
    { .x = 1701, .y = 3428 },
    { .x = 1711, .y = 3400 },
    { .x = 1721, .y = 3372 },
    { .x = 1731, .y = 3344 },
    { .x = 1741, .y = 3315 },
    { .x = 1751, .y = 3289 },
    { .x = 1761, .y = 3261 },
    { .x = 1771, .y = 3233 },
    { .x = 1781, .y = 3206 },
    { .x = 1791, .y = 3179 },
    { .x = 1801, .y = 3151 },
    { .x = 1811, .y = 3124 },
    { .x = 1821, .y = 3097 },
    { .x = 1831, .y = 3070 },
    { .x = 1841, .y = 3043 },
    { .x = 1851, .y = 3016 },
    { .x = 1861, .y = 2990 },
    { .x = 1871, .y = 2963 },
    { .x = 1881, .y = 2936 },
    { .x = 1891, .y = 2910 },
    { .x = 1901, .y = 2883 },
    { .x = 1911, .y = 2857 },
    { .x = 1921, .y = 2830 },
    { .x = 1931, .y = 2804 },
    { .x = 1941, .y = 2778 },
    { .x = 1951, .y = 2751 },
    { .x = 1961, .y = 2725 },
    { .x = 1971, .y = 2699 },
    { .x = 1981, .y = 2673 },
    { .x = 1991, .y = 2647 },
    { .x = 2001, .y = 2621 },
    { .x = 2011, .y = 2595 },
    { .x = 2021, .y = 2570 },
    { .x = 2031, .y = 2544 },
    { .x = 2041, .y = 2518 },
    { .x = 2051, .y = 2492 },
    { .x = 2061, .y = 2467 },
    { .x = 2071, .y = 2441 },
    { .x = 2081, .y = 2415 },
    { .x = 2091, .y = 2390 },
    { .x = 2101, .y = 2364 },
    { .x = 2111, .y = 2339 },
    { .x = 2121, .y = 2314 },
    { .x = 2131, .y = 2288 },
    { .x = 2141, .y = 2263 },
    { .x = 2151, .y = 2238 },
    { .x = 2161, .y = 2212 },
    { .x = 2171, .y = 2187 },
    { .x = 2181, .y = 2162 },
    { .x = 2191, .y = 2137 },
    { .x = 2201, .y = 2111 },
    { .x = 2211, .y = 2086 },
    { .x = 2221, .y = 2061 },
    { .x = 2231, .y = 2036 },
    { .x = 2241, .y = 2011 },
    { .x = 2251, .y = 1986 },
    { .x = 2261, .y = 1961 },
    { .x = 2271, .y = 1936 },
    { .x = 2281, .y = 1911 },
    { .x = 2291, .y = 1886 },
    { .x = 2301, .y = 1861 },
    { .x = 2311, .y = 1836 },
    { .x = 2321, .y = 1811 },
    { .x = 2331, .y = 1786 },
    { .x = 2341, .y = 1761 },
    { .x = 2351, .y = 1736 },
    { .x = 2361, .y = 1711 },
    { .x = 2371, .y = 1686 },
    { .x = 2381, .y = 1661 },
    { .x = 2391, .y = 1636 },
    { .x = 2401, .y = 1612 },
    { .x = 2411, .y = 1587 },
    { .x = 2421, .y = 1562 },
    { .x = 2431, .y = 1537 },
    { .x = 2441, .y = 1512 },
    { .x = 2451, .y = 1487 },
    { .x = 2461, .y = 1462 },
    { .x = 2471, .y = 1437 },
    { .x = 2481, .y = 1412 },
    { .x = 2491, .y = 1387 },
    { .x = 2501, .y = 1362 },
    { .x = 2511, .y = 1337 },
    { .x = 2521, .y = 1312 },
    { .x = 2531, .y = 1287 },
    { .x = 2541, .y = 1262 },
    { .x = 2551, .y = 1237 },
    { .x = 2561, .y = 1212 },
    { .x = 2571, .y = 1187 },
    { .x = 2581, .y = 1162 },
    { .x = 2591, .y = 1137 },
    { .x = 2601, .y = 1111 },
    { .x = 2611, .y = 1086 },
    { .x = 2621, .y = 1061 },
    { .x = 2631, .y = 1036 },
    { .x = 2641, .y = 1010 },
    { .x = 2651, .y = 985 },
    { .x = 2661, .y = 960 },
    { .x = 2671, .y = 934 },
    { .x = 2681, .y = 909 },
    { .x = 2691, .y = 884 },
    { .x = 2701, .y = 858 },
    { .x = 2711, .y = 832 },
    { .x = 2721, .y = 807 },
    { .x = 2731, .y = 781 },
    { .x = 2741, .y = 756 },
    { .x = 2751, .y = 730 },
    { .x = 2761, .y = 704 },
    { .x = 2771, .y = 678 },
    { .x = 2781, .y = 652 },
    { .x = 2791, .y = 626 },
    { .x = 2801, .y = 600 },
    { .x = 2811, .y = 574 },
    { .x = 2821, .y = 548 },
    { .x = 2831, .y = 522 },
    { .x = 2841, .y = 496 },
    { .x = 2851, .y = 469 },
    { .x = 2861, .y = 443 },
    { .x = 2871, .y = 417 },
    { .x = 2881, .y = 390 },
    { .x = 2891, .y = 363 },
    { .x = 2901, .y = 337 },
    { .x = 2911, .y = 310 },
    { .x = 2921, .y = 283 },
    { .x = 2931, .y = 256 },
    { .x = 2941, .y = 229 },
    { .x = 2951, .y = 202 },
    { .x = 2961, .y = 175 },
    { .x = 2971, .y = 148 },
    { .x = 2981, .y = 120 },
    { .x = 2991, .y = 93 },
    { .x = 3001, .y = 65 },
    { .x = 3011, .y = 37 },
    { .x = 3021, .y = 10 },
};